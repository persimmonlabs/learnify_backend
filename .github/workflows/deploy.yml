name: Deploy Application

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        type: choice
        options:
          - staging
          - production
      version:
        description: 'Docker image tag to deploy'
        required: true
        default: 'latest'
  push:
    tags:
      - 'v*.*.*'

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    if: github.event.inputs.environment == 'staging' || (github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v'))
    environment:
      name: staging
      url: https://staging.example.com

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up environment
        run: |
          echo "DEPLOY_ENV=staging" >> $GITHUB_ENV
          echo "IMAGE_TAG=${{ github.event.inputs.version || github.ref_name }}" >> $GITHUB_ENV

      - name: Run database migrations
        run: |
          echo "Running database migrations for staging..."
          # ./scripts/migrate.sh staging up

      - name: Deploy to staging
        env:
          DEPLOY_KEY: ${{ secrets.STAGING_DEPLOY_KEY }}
          DEPLOY_HOST: ${{ secrets.STAGING_HOST }}
        run: |
          echo "Deploying to staging environment..."
          # ./scripts/deploy.sh staging ${{ env.IMAGE_TAG }}

      - name: Health check
        run: |
          echo "Running health checks..."
          # ./scripts/health-check.sh staging
          sleep 10
          curl -f https://staging.example.com/health || exit 1

      - name: Run smoke tests
        run: |
          echo "Running smoke tests..."
          # Add smoke test commands here

      - name: Rollback on failure
        if: failure()
        run: |
          echo "Deployment failed, rolling back..."
          # ./scripts/rollback.sh staging

  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    if: github.event.inputs.environment == 'production'
    needs: []
    environment:
      name: production
      url: https://production.example.com

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up environment
        run: |
          echo "DEPLOY_ENV=production" >> $GITHUB_ENV
          echo "IMAGE_TAG=${{ github.event.inputs.version }}" >> $GITHUB_ENV

      - name: Create deployment backup
        run: |
          echo "Creating backup..."
          # ./scripts/backup.sh production

      - name: Run database migrations
        run: |
          echo "Running database migrations for production..."
          # ./scripts/migrate.sh production up

      - name: Deploy to production (blue-green)
        env:
          DEPLOY_KEY: ${{ secrets.PRODUCTION_DEPLOY_KEY }}
          DEPLOY_HOST: ${{ secrets.PRODUCTION_HOST }}
        run: |
          echo "Deploying to production environment..."
          # ./scripts/deploy.sh production ${{ env.IMAGE_TAG }}

      - name: Health check
        run: |
          echo "Running health checks..."
          # ./scripts/health-check.sh production
          sleep 15
          curl -f https://production.example.com/health || exit 1

      - name: Switch traffic
        run: |
          echo "Switching traffic to new deployment..."
          # ./scripts/switch-traffic.sh production

      - name: Run production smoke tests
        run: |
          echo "Running production smoke tests..."
          # Add comprehensive smoke tests

      - name: Rollback on failure
        if: failure()
        run: |
          echo "Production deployment failed, rolling back..."
          # ./scripts/rollback.sh production

      - name: Clean up old deployments
        if: success()
        run: |
          echo "Cleaning up old deployments..."
          # Keep last 3 deployments

  notify-deployment:
    name: Notify Deployment Status
    runs-on: ubuntu-latest
    needs: [deploy-staging, deploy-production]
    if: always()

    steps:
      - name: Determine status
        id: status
        run: |
          if [ "${{ needs.deploy-staging.result }}" == "success" ] || [ "${{ needs.deploy-production.result }}" == "success" ]; then
            echo "status=success" >> $GITHUB_OUTPUT
          else
            echo "status=failure" >> $GITHUB_OUTPUT
          fi

      - name: Send Slack notification
        if: env.SLACK_WEBHOOK_URL != ''
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          STATUS="${{ steps.status.outputs.status }}"
          COLOR="good"
          if [ "$STATUS" != "success" ]; then
            COLOR="danger"
          fi

          ENV="${{ github.event.inputs.environment || 'staging' }}"
          VERSION="${{ github.event.inputs.version || github.ref_name }}"

          curl -X POST $SLACK_WEBHOOK_URL \
            -H 'Content-Type: application/json' \
            -d "{
              \"attachments\": [{
                \"color\": \"$COLOR\",
                \"title\": \"ðŸš€ Deployment - $STATUS\",
                \"text\": \"Deployment to $ENV completed\",
                \"fields\": [
                  {\"title\": \"Environment\", \"value\": \"$ENV\", \"short\": true},
                  {\"title\": \"Version\", \"value\": \"$VERSION\", \"short\": true},
                  {\"title\": \"Deployed by\", \"value\": \"${{ github.actor }}\", \"short\": true},
                  {\"title\": \"Status\", \"value\": \"$STATUS\", \"short\": true}
                ]
              }]
            }"

      - name: Create deployment record
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.repos.createDeploymentStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              deployment_id: context.payload.deployment?.id || 0,
              state: '${{ steps.status.outputs.status }}',
              environment: '${{ github.event.inputs.environment || 'staging' }}',
              description: 'Deployment ${{ steps.status.outputs.status }}'
            });
